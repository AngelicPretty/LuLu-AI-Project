# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.

import os
import json
import Chatgpt
import lulu_bot_api

from typing import List
from botbuilder.core import CardFactory, TurnContext, MessageFactory
from botbuilder.core.teams import TeamsActivityHandler, TeamsInfo
from botbuilder.schema import CardAction, HeroCard, Mention, ConversationParameters, Attachment, Activity, CardImage, ChannelAccount
from botbuilder.schema.teams import TeamInfo, TeamsChannelAccount
from botbuilder.schema._connector_client_enums import ActionTypes

ADAPTIVECARDTEMPLATE = "resources/UserMentionCardTemplate.json"

class TeamsConversationBot(TeamsActivityHandler):
	def __init__(self, app_id: str, app_password: str):
		self._app_id = app_id
		self._app_password = app_password

	async def on_message_activity(self, turn_context: TurnContext):
		TurnContext.remove_recipient_mention(turn_context.activity)
		text = turn_context.activity.text.strip().lower()
		print("[+] Content message: ", text)
		if "bot:" in text:
			await self._chatgpt(turn_context, text)
			return

		if "hi" in text or "你好" in text:
			await self._lulu_activity(turn_context)
			return

		if "搜索" in text:
			await self._user_profiles(turn_context, text)
			return

		if "chatgpt" in text:
			await self._chatgpt_info(turn_context, text)
			return

		if "wifi" in text:
			await self._wifi_card(turn_context)
			return

		if "重置" in text or "密码" in text:
			await self._password_reset(turn_context, text)
			return

		if "wifi" in text:
			await self._wifi_card(turn_context)
			return

		if "who" in text:
			await self._get_member(turn_context)
			return

		if "card" in text:
			await self._send_card(turn_context, True)
			return

		print("[-] Warn: No found keyword")

	async def _lulu_activity(self, turn_context: TurnContext):
		print("[+] Paimon: Welcome")
		mention = Mention(
			mentioned=turn_context.activity.from_property,
			text=f"<at>{turn_context.activity.from_property.name}</at>",
		)
		#reply_activity = MessageFactory.text(f"Hello {mention.text}")
		reply_activity = MessageFactory.text("你好啊,我名字叫Paimon!")
		reply_activity.entities = [Mention().deserialize(mention.serialize())]
		await turn_context.send_activity(reply_activity)

	async def _user_profiles(self, turn_context: TurnContext, message):
		reply_activity = MessageFactory.text("正在搜索用户中！请稍等片刻...")
		await turn_context.send_activity(reply_activity)
		search_name = message[message.index("搜索") + 2:]
		json_resp = lulu_bot_api.user_profiles(search_name)
		if json_resp is not None:
			reply_activity = MessageFactory.text("Paimon已经成功搜索到！")
			await turn_context.send_activity(reply_activity)
			displayName = lulu_bot_api.json_to_str(json_resp["displayName"])
			displayName = bytes(displayName, 'utf-8').decode('unicode_escape')
			user_id = json_resp["id"]
			officeLocation = lulu_bot_api.json_to_str(json_resp["officeLocation"])
			mail = lulu_bot_api.json_to_str(json_resp["mail"])
			reply = "姓名: " + displayName + "\n" + "UID: "  + user_id + "\n" + "办公地点: " + officeLocation + "\n" + " 邮箱地址: " + mail
			reply_activity = MessageFactory.text(reply)
			await turn_context.send_activity(reply_activity)
		elif json_resp is False:
			reply_activity = MessageFactory.text("对不起哦,服务器发生错误,请联系IT")
			await turn_context.send_activity(reply_activity)
		else:
			reply_activity = MessageFactory.text("对不起,没有找到相关人员,请重新搜索")
			await turn_context.send_activity(reply_activity)

	async def _chatgpt_info(self, turn_context: TurnContext, message):
		reply_activity = MessageFactory.text("Paimon正在接入ChatGpt中！请稍等片刻...")
		await turn_context.send_activity(reply_activity)
		reply_activity = MessageFactory.text("ChatGpt接入成功！请前面加上bot:对我进行对话...")
		await turn_context.send_activity(reply_activity)

	async def _chatgpt(self, turn_context: TurnContext, message):
		message = message[message.index("bot:") + 4:]
		reply = Chatgpt.send_chatgpt_message(message)
		reply_activity = MessageFactory.text(reply)
		await turn_context.send_activity(reply_activity)

	async def _password_reset(self, turn_context: TurnContext, message):
		reply_activity = MessageFactory.text("正在重置密码中！请稍等片刻...")
		await turn_context.send_activity(reply_activity)
		user = message[message.index("密码") + 2:]
		json_resp, user_name = lulu_bot_api.change_password(user)
		if json_resp is not None:
			tmpassword = json_resp["newPassword"]
			reply = "成功为您重置密码!\n" + "用户名: " + user_name + "\n" + "临时密码: " + tmpassword + "\n"
			reply_activity = MessageFactory.text(reply)
			await turn_context.send_activity(reply_activity)
		else:
			reply_activity = MessageFactory.text("对不起哦旅行者,冒险世界里面没有这个人,重置密码失败！")
			await turn_context.send_activity(reply_activity)

	async def _wifi_card(self, turn_context: TurnContext):
		reply_activity = MessageFactory.text("您好,WiFi密码为wuhan2013")
		await turn_context.send_activity(reply_activity)
		image_path = 'resources/WiFi_Card.png'
		with open(image_path, "rb") as image_file:
			image_data = image_file.read()
		image_name = os.path.basename(image_path)
		image_attachment = Attachment(
			content_url="https://3a49-61-242-144-162.ngrok-free.app/image/WiFi_Card.png",
			content_type="image/png",
			name = image_name
		)
		#attachment = lulu_bot_api.image_send(path)
		reply_activity = MessageFactory.attachment(image_attachment)
		await turn_context.send_activity(reply_activity)

	async def on_members_added_activity(self, members_added: List[ChannelAccount], turn_context: TurnContext):
		print("[+] Paimon join group success!")
		print(members_added)
		print(turn_context.activity.recipient.id)
		for member in members_added:
			print(member.id)
			if member.id == turn_context.activity.recipient.id:
				print("scuess")
				#reply_activity = MessageFactory.text("大家好，我是Paimon Bot。欢迎加入本群组！")
				#await turn_context.send_activity(reply_activity)

	async def _send_card(self, turn_context: TurnContext, isUpdate):
		card = HeroCard(
			title="Paimon Hero Card",
			subtitle="Your bots — wherever your users are talking",
			text="Build and connect intelligent bots to interact with your users naturally wherever they are, from text/sms to Skype, Slack, Office 365 mail and other popular services.",
			images=[CardImage(url="https://docs.microsoft.com/en-us/bot-framework/media/how-it-works/architecture-resize.png")],
			buttons=[CardAction(type=ActionTypes.open_url,
					title="Get Started",
					value="https://docs.microsoft.com/en-us/bot-framework/")]
			)
		reply_activity = MessageFactory.attachment(CardFactory.hero_card(card))
		await turn_context.send_activity(reply_activity)

	async def _get_member(self, turn_context: TurnContext):
		TeamsChannelAccount: member = None
		try:
			member = await TeamsInfo.get_member(turn_context, turn_context.activity.from_property.id)
		except Exception as e:
			if "MemberNotFoundInConversation" in e.args[0]:
				await turn_context.send_activity("Member not found.")
				return
			else:
				raise
		else:
			await turn_context.send_activity(f"You are: {member.name}")
